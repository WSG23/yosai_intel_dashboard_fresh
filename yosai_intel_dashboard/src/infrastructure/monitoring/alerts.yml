# Alert rules for Prometheus
# Trigger when replication lag exceeds 60 seconds
---
groups:
  - name: timescale
    rules:
      - alert: TimescaleReplicationLag
        expr: replication_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Replication lag to TimescaleDB exceeds 60 seconds
          channels: performance-alerts

  - name: performance-budgets
    rules:
      - alert: PerformanceBudgetExceeded
        expr: performance_budget_exceeded_total > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: A performance budget was exceeded
          channels: performance-alerts
  - name: error-budgets
    rules:
      - alert: ErrorBudgetExhausted
        expr: service_error_budget_remaining <= 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: Service error budget exhausted
          channels: performance-alerts

  - name: feature-flags
    rules:
      - alert: HighFeatureFlagFallbackRate
        expr: rate(feature_flag_fallback_total[5m]) / rate(feature_flag_evaluations_total[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High feature flag fallback rate detected
          channels: performance-alerts
      - alert: MissingOptionalDependencies
        expr: optional_dependency_missing_total > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Optional dependency missing
          channels: performance-alerts

  - name: backups
    rules:
      - alert: BackupJobStale
        expr: time() - backup_last_success_timestamp > 86400
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: No successful backup in the last 24 hours
          channels: ops-alerts
      - alert: BackupJobFailed
        expr: increase(backup_failures_total[1h]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Backup job failure detected
          channels: ops-alerts

