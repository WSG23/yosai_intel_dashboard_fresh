# Template for canary deployment using Istio weight-based routing
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-service-stable
  labels:
    app: example-service
    track: stable
spec:
  replicas: 3
  selector:
    matchLabels:
      app: example-service
      track: stable
  template:
    metadata:
      labels:
        app: example-service
        track: stable
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: example-service
          image: example:${IMAGE_TAG:-v0.1.0}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-service-canary
  labels:
    app: example-service
    track: canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-service
      track: canary
  template:
    metadata:
      labels:
        app: example-service
        track: canary
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: example-service
          image: example:new
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: example-service
spec:
  host: example-service
  subsets:
    - name: stable
      labels:
        track: stable
    - name: canary
      labels:
        track: canary
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: example-service
spec:
  hosts:
    - example-service
  http:
    - route:
        - destination:
            host: example-service
            subset: stable
          weight: 90
        - destination:
            host: example-service
            subset: canary
          weight: 10
